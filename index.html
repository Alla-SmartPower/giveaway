function doPost(e) {
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Sheet1');

    const data = JSON.parse(e.postData.contents || '{}');
    const fullName = (data.fullName || '').trim();

    if (!fullName) {
      return jsonResponse({ ok: false, message: 'Вкажіть ПІБ' });
    }

    if (fullName.length < 5 || fullName.length > 120) {
      return jsonResponse({ ok: false, message: 'Некоректне ПІБ' });
    }

    const normalized = normalizeName(fullName);

    const lastRow = sheet.getLastRow();
    if (lastRow >= 2) {
      const existing = sheet.getRange(2, 3, lastRow - 1, 1).getValues().flat();
      if (existing.includes(normalized)) {
        return jsonResponse({ ok: false, message: 'Такий учасник вже зареєстрований' });
      }
    }

    sheet.appendRow([new Date(), fullName, normalized, 'accepted']);

    return jsonResponse({ ok: true, message: 'Заявку прийнято ✅' });

  } catch (err) {
    return jsonResponse({ ok: false, message: 'Помилка сервера', error: String(err) });
  }
}

function doGet() {
  return jsonResponse({ ok: true, message: 'API працює' });
}

function normalizeName(name) {
  return name
    .toLowerCase()
    .replace(/\s+/g, ' ')
    .replace(/[’'`]/g, "'")
    .trim();
}

function jsonResponse(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
